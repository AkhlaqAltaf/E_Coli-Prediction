<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamE</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            overflow-x: hidden;
        }
        body {
            background: url('https://images.pexels.com/photos/2049422/pexels-photo-2049422.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1') no-repeat center center fixed;
            background-size: cover;
            color: #333;
        }
        .overlay {
            position: fixed; /* Fixed position to cover the whole viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.5); /* White background with 50% opacity */
            z-index: 1;
            pointer-events: none; /* Allow clicks through the overlay */
        }
        .content {
            position: relative;
            z-index: 2;
        }
        .navbar {
            background-color: #2d2e83;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        .navbar-brand {
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .navbar-nav .nav-link {
            color: #fff;
        }
        .navbar-nav .dropdown-menu {
            background-color: #2d2e83;
            color: #fff;
        }
        .navbar-nav .dropdown-menu .dropdown-item {
            color: #fff;
        }
        .navbar-nav .dropdown-menu .dropdown-item:hover {
            background-color: #4547a3;
        }
        .ai-icon {
            color: #f39c12;
        }
        footer {
            background-color: #2d2e83;
            color: #fff;
            padding: 1rem 0;
            text-align: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }
        #content-wrapper {
            padding-top: 80px;
            padding-bottom: 60px;
            min-height: calc(100vh - 140px); /* 80px navbar + 60px footer */
            position: relative; /* Ensure content is above the overlay */
        }
        #loader {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            display: none;
        }
        @media (max-width: 576px) {
            #weather-chart {
                width: 100% !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="overlay"></div> <!-- Background overlay with opacity -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="/">StreamE</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Select Creek
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="{% url 'website:creekname' creekname='eaglecreek' %}">Eagle Creek</a>
                        <a class="dropdown-item" href="{% url 'website:creekname' creekname='fallcreek' %}">Fall Creek</a>
                        <a class="dropdown-item" href="{% url 'website:creekname' creekname='whitecreek' %}">White Creek</a>
                        <a class="dropdown-item" href="{% url 'website:creekname' creekname='lick' %}">Lick Creek</a>
                        <a class="dropdown-item" href="{% url 'website:creekname' creekname='pogues' %}">Pogues Run</a>
                        <a class="dropdown-item" href="{% url 'website:creekname' creekname='statecreek' %}">State Creek</a>
                        <a class="dropdown-item" href="{% url 'website:creekname' creekname='crooked' %}">Crooked Creek</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Contact</a>
                </li>
            </ul>
        </div>
    </nav>
    <div id="loader">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <div id="content-wrapper" class="container mt-5 content">
        {% block content %}
        <canvas id="weather-chart"></canvas>
        {% endblock %}
    </div>
    <footer>
        <p>&copy; 2024 StreamE | Powered by AI <i class="fas fa-robot ai-icon"></i></p>
    </footer>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.0"></script>
    <script>
        $(document).ready(function() {
            // fetchHistoricalData();

            let chart; // To hold the chart instance

            function fetchWeatherData(lat, lon) {
                $('#loader').removeClass('d-none'); // Show loader
                $.ajax({
                    url: '/weather-data',
                    data: {
                        lat: lat,
                        lon: lon,
                        creek: "eaglecreek"
                    },
                    success: function(data) {
                        $('#loader').addClass('d-none'); // Hide loader
                        let labels = [];
                        let precipitations = [];
                        let temps = [];
                        let maxTemps = [];
                        let minTemps = [];
                        let alerts = [];

                        data.forEach(function(row) {
                            labels.push(row.date);
                            precipitations.push(row.Precipitation);
                            temps.push(row.Temp);
                            maxTemps.push(row.MaxTemp);
                            minTemps.push(row.MinTemp);
                            alerts.push(row.prediction === 1);
                        });

                        renderChart(labels, precipitations, temps, maxTemps, minTemps, alerts);
                    },
                    error: function() {
                        $('#loader').addClass('d-none'); // Hide loader
                        alert('Failed to fetch weather data');
                    }
                });
            }

            function renderChart(labels, precipitations, temps, maxTemps, minTemps, alerts) {
                const ctx = document.getElementById('weather-chart').getContext('2d');

                // Destroy the old chart instance if it exists
                if (chart) {
                    chart.destroy();
                }

                // Create a new chart instance
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Precipitation (mm)',
                                data: precipitations,
                                borderColor: 'blue',
                                backgroundColor: 'rgba(0, 0, 255, 0.1)',
                                fill: true
                            },
                            {
                                label: 'Temperature (°C)',
                                data: temps,
                                borderColor: 'green',
                                backgroundColor: 'rgba(0, 255, 0, 0.1)',
                                fill: true
                            },
                            {
                                label: 'Max Temperature (°C)',
                                data: maxTemps,
                                borderColor: 'red',
                                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                                fill: true
                            },
                            {
                                label: 'Min Temperature (°C)',
                                data: minTemps,
                                borderColor: 'orange',
                                backgroundColor: 'rgba(255, 165, 0, 0.1)',
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Ensures the chart is responsive
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: '#000'
                                },
                                ticks: {
                                    color: '#000' // Strong black color for labels
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Value',
                                    color: '#000'
                                },
                                ticks: {
                                    color: '#000' // Strong black color for labels
                                }
                            }
                        },
                        plugins: {
                            annotation: {
                                annotations: alerts.map((alert, index) => {
                                    if (alert) {
                                        return {
                                            type: 'line',
                                            mode: 'vertical',
                                            scaleID: 'x',
                                            value: labels[index],
                                            borderColor: 'red',
                                            borderWidth: 2,
                                            label: {
                                                content: 'Alert',
                                                enabled: true,
                                                position: 'top'
                                            }
                                        };
                                    }
                                    return null;
                                }).filter(annotation => annotation !== null)
                            }
                        }
                    }
                });
            }

            // Fetch data for the default location on page load
            let defaultLocation = $('#location-dropdown').val();
            let defaultCoords = defaultLocation.split(',');

            fetchWeatherData(defaultCoords[0], defaultCoords[1]);
            fetchHistoricalData();


            $('#location-dropdown').change(function() {

                let selectedLocation = $(this).val();
                let coords = selectedLocation.split(',');

                fetchWeatherData(coords[0], coords[1]);
                fetchHistoricalData();

            });
$('#start-date-picker').change(function() {

fetchHistoricalData();

});

$('#end-date-picker').change(function() {

fetchHistoricalData();

});
        function fetchHistoricalData() {
            const location = $('#location-dropdown').val();
            const creek = "{{ creekname }}";
            const [lat, long] = location.split(',');
            const startDate = $('#start-date-picker').val();
            const endDate = $('#end-date-picker').val();

            if (!location || !startDate || !endDate) return;

            $('#historical-loader').removeClass('d-none');

            $.ajax({
                url: '/historical/',
                // type: 'POST',
             
                data: {
                    lat: lat,
                    lon: long,
                    creek: creek,
                    start_date: startDate,
                    end_date: endDate
                },
                success: function(data) {
                    console.log(data);
                    $('#historical-loader').addClass('d-none');
                    updateHistoricalTable(data);
                },
                error: function() {
                    $('#historical-loader').addClass('d-none');
                    alert('Failed to fetch historical data');
                }
            });
        }

        function updateHistoricalTable(data) {
            const tableBody = $('#historical-data-table tbody');
            tableBody.empty();

            data.forEach(row => {
                const alert = row.prediction == 1 ? "Yes Alert" : "No Alert";
                const alertColor = row.prediction == 1 ? "red" : "green";

                const tr = `<tr>
                    <td>${row.date}</td>
                    <td>${row.Temp}</td>
                    <td>${row.MinTemp}</td>
                    <td>${row.MaxTemp}</td>
                    <td>${row.Precipitation}</td>
                    <td>${row.Season}</td>
                    <td style="color: ${alertColor};">${alert}</td>
                </tr>`;
                tableBody.append(tr);
            });
        }
        });

    </script>
</body>
</html>
