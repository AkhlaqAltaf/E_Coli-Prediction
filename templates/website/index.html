{% extends 'website/base.html' %}
{% load static %}

{% block content %}

<head>
    <meta charset="utf-8">
    <title>Weather Forecast</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Ubuntu:wght@500;700&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="{% static 'lib/animate/animate.min.css' %}" rel="stylesheet">
    <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/weather.css' %}" rel="stylesheet">
</head>

<div style="background-image: url('{% static 'img/pexels-kelly-1179532-3030282.jpg' %}');">

    <!-- About Start -->
    <div class="container-fluid py-5">
        <div class="container">
            <div class="row align-items-center">

                <div class="col-lg-12 wow fadeIn" data-wow-delay="0.5s">
                    <h1 class="mb-1">Check the weather forecast</h1>

                   <div class="container_weather">
                    <div id="loader" class="d-none text-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <div class="weather__header">
                        <div class="form-group">

                            <label for="location-dropdown">Select Location:</label>
                            <select class="form-control" id="location-dropdown">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="weather__units">
                            <span class="weather_unit_celsius">&#176C</span>
                            <span class="weather_unit_fahrenheit">&#176F</span>
                        </div>
                    </div>
                    <div class="weather__body">
                        <h1 class="weather__city text-white"></h1>
                        <div class="weather__datetime"></div>
                        <div class="weather__forecast"></div>
                        <div class="weather__icon"></div>
                        <p class="weather__temperature"></p>
                        <div class="weather__minmax">
                            <p>Min: 12&#176</p>
                            <p>Max: 16&#176</p>
                        </div>
                    </div>
                    <div class="weather__info">
                        <div class="weather__card">
                            <i class="fa-solid fa-temperature-full"></i>
                            <div>
                                <p>Real Feel</p>
                                <p class="weather__realfeel" id="temp">18&#176</p>
                            </div>
                        </div>
                        <div class="weather__card">
                            <i class="fa-solid fa-droplet"></i>
                            <div>
                                <p>Humidity</p>
                                <p class="weather__humidity">18&#176</p>
                            </div>
                        </div>
                        <div class="weather__card">
                            <i class="fa-solid fa-wind"></i>
                            <div>
                                <p>Wind</p>
                                <p class="weather__wind">18&#176</p>
                            </div>
                        </div>
                        <div class="weather__card">
                            <i class="fa-solid fa-gauge-high"></i>
                            <div>
                                <p>Pressure</p>
                                <p class="weather__pressure">18&#176</p>
                            </div>
                        </div>
                    </div>
                </div>

                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.0"></script>
        <script>
            const creekLocations = {
                "Eagle Creek": [
                    { value: "39.73567,-86.19647", text: "Raymond St" },
                    { value: "39.75048,-86.20769", text: "Morris St" },
                    { value: "39.772,-86.234417", text: "Grande Ave" },
                    { value: "39.780472,-86.259722", text: "10th St." },
                    { value: "39.88778,-86.306917", text: "Lafayette Rd." },
                    { value: "39.925944,-86.278861", text: "Ford Rd." }
                ],
                "Fall Creek": [
                    { value: "39.8355,-86.1182", text: "Fall Creek @ Keystone Ave" },
                    { value: "39.810472,-86.14214", text: "Fall Creek @ 30th St" },
                    { value: "39.805583,-86.1496", text: "Fall Creek @ Central Ave" },
                    { value: "39.8025,-86.159", text: "Fall Creek @ Illinois St" },
                    { value: "39.797167,-86.16942", text: "Fall Creek @ MLK" },
                    { value: "39.781778,-86.17683", text: "Fall Creek @ Indiana Ave" },
                    { value: "39.84472,-86.0679", text: "Devon Creek @ Radnor Rd" },
                    { value: "39.838768,-86.093856", text: "Devon Creek @ Brown Rd" },
                    { value: "39.841028,-86.100944", text: "Devon Creek @ Millersville Rd" }
                ],
                "Lick Creek": [
                    { value: "39.769680,-86.026249", text: "Lick Creek @ Franklin Rd" },
                    { value: "39.746819,-86.063829", text: "Lick Creek @ Arlington Ave" },
                    { value: "39.736023,-86.082626", text: "Lick Creek @ Emerson Ave" },
                    { value: "39.721614,-86.095657", text: "Lick Creek @ Main St" },
                    { value: "39.703886,-86.120591", text: "Lick Creek @ Keystone Ave" },
                    { value: "39.702099,-86.158224", text: "Lick Creek @ Meridian St" },
                    { value: "39.708401,-86.187166", text: "Lick Creek @ Harding St" }
                ],
                "White Creek": [
                    { value: "52.52,13.41", text: "Berlin, Germany" },
                    { value: "40.71,-74.01", text: "New York, USA" },
                    { value: "34.05,-118.24", text: "Los Angeles, USA" },
                    { value: "48.85,2.35", text: "Paris, France" },
                    { value: "35.68,139.69", text: "Tokyo, Japan" }
                ],
                "State Creek": [
                    { value: "39.73131,-86.233", text: "State Ditch @ Bradbury Ave" },
                    { value: "39.72527,-86.2609", text: "Mars Ditch @ Fortune Cir W Dr" },
                    { value: "39.71608,-86.241194", text: "Seerley Creek @ Southwest Dr" },
                    { value: "39.71297,-86.2344", text: "State Ditch @ Mooresville Rd" },
                    { value: "39.69183,-86.232", text: "State Ditch @ Thompson Rd" }
                ],
                "Pogues Run": [
                    { value: "39.756823,-86.173353", text: "White River @ Kentucky Ave" },
                    { value: "39.771778,-86.186278", text: "White River @ New York St" },
                    { value: "39.771,-86.141", text: "Pogues Run @ New York St" },
                    { value: "39.780194,-86.133833", text: "Pogues Run @ 10th St" },
                    { value: "39.787194,-86.116444", text: "Pogues Run @ Rural St" },
                    { value: "39.79625,-86.098639", text: "Pogues Run @ 21st St" },
                    { value: "39.808667,-86.082083", text: "Pogues Run @ Emerson Ave" },
                    { value: "39.825389,-86.065667", text: "Pogues Run @ 38th St" }
                ],
                "Crooked Creek": [
                    { value: "39.797472,-86.042556", text: "Pleasant Run @ 21st St" },
                    { value: "39.775917,-86.064333", text: "Pleasant Run @ Arlington Ave" },
                    { value: "39.752056,-86.075139", text: "Bean Creek @ Orange St" },
                    { value: "39.758167,-86.107611", text: "Pleasant Run @ Southeastern Ave" },
                    { value: "39.729333,-86.120944", text: "Bean Creek @ Keystone Ave" },
                    { value: "39.744111,-86.140944", text: "Pleasant Run @ Barth Ave" },
                    { value: "39.736167,-86.147528", text: "Pleasant Run @ Garfield Park" },
                    { value: "39.735028,-86.148167", text: "Bean Creek @ Garfield Park" },
                    { value: "39.727861,-86.167778", text: "Pleasant Run @ Bluff Rd" },
                    { value: "39.752608,-86.117583", text: "Pleasant Run @ Prospect St" },
                    { value: "39.728917,-86.1395", text: "Bean Creek @ Shelby St" }
                ]
            };

            document.addEventListener('DOMContentLoaded', function() {
                const dropdown = document.getElementById('location-dropdown');
                dropdown.innerHTML = ''; // Clear existing options

                for (const [creek, locations] of Object.entries(creekLocations)) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = creek;

                    locations.forEach(function(location) {
                        const option = document.createElement('option');
                        option.value = location.value;
                        option.textContent = location.text;
                        optgroup.appendChild(option);
                    });

                    dropdown.appendChild(optgroup);
                }
            });

            $(document).ready(function() {
            // fetchHistoricalData();

            let chart; // To hold the chart instance

            function fetchWeatherData(lat, lon) {

                console.log("FETCHING WEATHER DATA");
                $('#loader').removeClass('d-none'); // Show loader
                $.ajax({
                    url: '/weather-data',
                    data: {
                        lat: lat,
                        lon: lon,
                        creek: "eaglecreek"
                    },
                    success: function(data) {
                        $('#loader').addClass('d-none'); // Hide loader
                        let labels = [];
                        let precipitations = [];
                        let temps = [];
                        let maxTemps = [];
                        let minTemps = [];
                        let alerts = [];

                        data.forEach(function(row) {
                            labels.push(row.date);
                            precipitations.push(row.Precipitation);
                            temps.push(row.Temp);
                            maxTemps.push(row.MaxTemp);
                            minTemps.push(row.MinTemp);
                            alerts.push(row.prediction === 1);
                        });

                    },
                    error: function() {
                        $('#loader').addClass('d-none'); // Hide loader
                        alert('Failed to fetch weather data');
                    }
                });
            }

          

            // Fetch data for the default location on page load
            let defaultLocation = $('#location-dropdown').val();
            let defaultCoords = defaultLocation.split(',');

            fetchWeatherData(defaultCoords[0], defaultCoords[1]);


            $('#location-dropdown').change(function() {

                let selectedLocation = $(this).val();
                let coords = selectedLocation.split(',');

                fetchWeatherData(coords[0], coords[1]);

            });


            function updateHistoricalTable(data) {
          

            data.forEach(row => {

                const alert = row.prediction == 1 ? "Yes Alert" : "No Alert";
                const alertColor = row.prediction == 1 ? "red" : "green";

                console.log("TEMPERATURE DATA UPDATED");

                // $('#temp').html(`${row.Temp[0]}&#176`);

                const tr = `<tr>
                    <td>${row.date}</td>
                    <td>${row.Temp}</td>
                    <td>${row.MinTemp}</td>
                    <td>${row.MaxTemp}</td>
                    <td>${row.Precipitation}</td>
                    <td>${row.Season}</td>
                    <td style="color: ${alertColor};">${alert}</td>
                </tr>`;
                // tableBody.append(tr);
            });
        }
        });
        </script>
    </div>
    <!-- About End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top pt-2"><i class="bi bi-arrow-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'lib/wow/wow.min.js' %}"></script>
    <script src="{% static 'lib/easing/easing.min.js' %}"></script>
    <script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
    <script src="{% static 'lib/counterup/counterup.min.js' %}"></script>
    <script src="{% static 'lib/owlcarousel/owl.carousel.min.js' %}"></script>


</div>
{% endblock %}
